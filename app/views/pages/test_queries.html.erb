<%= form_tag do %>
  <h4>Choose an Intent</h4>
  <%= select_tag(
    'intents',
    options_for_select(
      [
        ['', ''],
        ['play_music', 'Play Hello by Adele.'],
        ['news_search', "What's the news on Trump?"]
      ],
      'play_music'
    ),
    onchange: 'fillWrapperQuery()'
  ) %>
<% end %>

<div class='wrapper-query'>
  <h4>Wrapper Query</h4>

  <%= form_tag '/wrapper-query' do %>
    <%= text_field_tag :wrapper_query, nil, class: 'form-control text-input' %>
    <%= submit_tag 'Test', class: 'btn lg black pull-right test-btn' %>
  <% end %>
  <br>
  <%= render partial: 'query_response' %>
</div>

<div class='nlu-query'>
  <h4>NLU Query</h4>

  <%= form_tag '/nlu-query' do %>
    <%= text_field_tag :nlu_query, nil, class: 'form-control text-input' %>
    <%= submit_tag 'Test', class: 'btn lg black pull-right test-btn' %>
  <% end %>
  <br>
  <%= render partial: 'query_response' %>
</div>

<div class='news-retrieve'>
  <h4>News Skill (Retrieve)</h4>

  <%= form_tag '/skills/news-skill-retrieve' do %>
    <%= text_area_tag(
      :news_skill_retrieve,
      File.read('app/views/test_data/news_skill_retrieve.json'),
      class: 'form-control text-input'
    ) %>
    <%= submit_tag 'Test', class: 'btn lg black pull-right test-btn' %>
  <% end %>
  <br>
  <%= render partial: 'query_response' %>
</div>

<div class='news-format'>
  <h4>News Skill (Format)</h4>

  <%= form_tag '/skills/news-skill-format' do %>
    <%= text_area_tag(
      :news_skill_format,
      File.read('app/views/test_data/news_skill_format.json'),
      class: 'form-control text-input'
    ) %>
    <%= submit_tag 'Test', class: 'btn lg black pull-right test-btn' %>
  <% end %>
  <br>
  <%= render partial: 'query_response' %>
</div>

<div class='music-retrieve'>
  <h4>Music Skill (Retrieve)</h4>

  <%= form_tag '/skills/music-skill-retrieve' do %>
    <%= text_area_tag(
      :music_skill_retrieve,
      File.read('app/views/test_data/music_skill_retrieve.json'),
      class: 'form-control text-input'
    ) %>
    <%= submit_tag 'Test', class: 'btn lg black pull-right test-btn' %>
  <% end %>
  <br>
  <%= render partial: 'query_response' %>
</div>

<div class='music-format'>
  <h4>Music Skill (Format)</h4>

  <%= form_tag '/skills/music-skill-format' do %>
    <%= text_area_tag(
      :music_skill_format,
      File.read('app/views/test_data/music_skill_format.json'),
      class: 'form-control text-input'
    ) %>
    <%= submit_tag 'Test', class: 'btn lg black pull-right test-btn' %>
  <% end %>
  <br>
  <%= render partial: 'query_response' %>
</div>

<script>
$('.test-btn').click(function(e){
    e.preventDefault();

    IAM.loading.start({ type:'logo', duration: false });

    var intent = $('#wrapper_query').val();
    $('#nlu_query').val(intent);
    var action = $(this).closest('form').attr('action');

    $.ajax({
        type: 'POST',
        dataType: 'json',
        headers: {
            'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        url:  action,
        data: $(this).siblings('.text-input').serialize()
    }).done(function(r){
       $('.iam-loading').each(function(){
            IAM.loading.stop({id: $(this).attr('rel')});
        });
        var this_div = $(this).closest('div');

        this_div.find('.server-time').html( r['time'] );
        this_div.find('.title').html(this_div.find('h4').html());
        this_div.find('.notes').addClass('in');
        this_div.find('.json').html(r['response']);

        // Highlight the code.
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block);
        });
    }.bind(this));
});
</script>
